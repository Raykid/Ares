var ares;(function(ares){var template;(function(template){function getChildrenString(node){var result="";var children=node.children;if(children){for(var i=0,len=children.length;i<len;i++){result+=children[i].value}}return result}template.getChildrenString=getChildrenString;function compileChildren(node,scope,compiler){node.children.forEach(function(child){compiler.compile(child,scope)},this)}template.compileChildren=compileChildren;function addCommand(name,command){if(!template.commands[name])template.commands[name]=command}template.addCommand=addCommand;template.commands={text:function(context){context.node.value=context.node.exp},exp:function(context){context.entity.createWatcher(context.node,context.node.exp,context.scope,function(value){context.node.value=value+""})},"if":function(context){context.entity.createWatcher(context.node,context.node.exp,context.scope,function(value){if(value){compileChildren(context.node,context.scope,context.compiler);context.node.value=getChildrenString(context.node)}else{context.node.value=""}})},"for":function(context){var reg=/^\s*(\S+)\s+in\s+(\S+)\s*$/;var res=reg.exec(context.node.exp);if(!res){console.error("for命令表达式错误："+context.node.exp);return}context.entity.createWatcher(context.node,res[2],context.scope,function(value){if(typeof value=="number"){var temp=[];for(var i=0;i<value;i++){temp.push(i)}value=temp}var result="";if(value){for(var key in value){var newScope=Object.create(context.scope);Object.defineProperty(newScope,"$index",{configurable:true,enumerable:false,value:value instanceof Array?parseInt(key):key,writable:false});Object.defineProperty(newScope,res[1],{configurable:true,enumerable:true,value:value[key],writable:false});compileChildren(context.node,newScope,context.compiler);result+=getChildrenString(context.node)}}context.node.value=result})}}})(template=ares.template||(ares.template={}))})(ares||(ares={}));var ares;(function(ares){var template;(function(template_1){var TemplateCompiler=function(){function TemplateCompiler(template,onUpdate,config){this._template=template;this._onUpdate=onUpdate;this._config=config}Object.defineProperty(TemplateCompiler.prototype,"root",{get:function(){return this._root},enumerable:true,configurable:true});TemplateCompiler.prototype.init=function(entity){this._entity=entity;this._root=this.transformToNode(this._template);this.compile(this._root,entity.data);this.update();this.mutateValue(this._root)};TemplateCompiler.prototype.compile=function(node,scope){this._scope=scope;var cmd=template_1.commands[node.cmd];if(cmd){var ctx={node:node,scope:scope,compiler:this,entity:this._entity};cmd(ctx)}if(node.children&&node.cmd!="if"&&node.cmd!="for"){template_1.compileChildren(node,scope,this)}};TemplateCompiler.prototype.update=function(){var text=template_1.getChildrenString(this._root);this._onUpdate(text)};TemplateCompiler.prototype.mutateValue=function(node){var value=node.value;var self=this;Object.defineProperty(node,"value",{configurable:true,enumerable:true,get:function(){return value},set:function(v){value=v;self.update()}});if(node.children){node.children.forEach(this.mutateValue,this)}};TemplateCompiler.prototype.getEndIndex=function(str,startIndex){var startIcons=["{",'"',"'","`","(","["];var endIcons=["}",'"',"'","`",")","]"];var stack=[0];for(var i=startIndex,len=str.length;i<len;i++){var tempChar=str.charAt(i);var startIndex=startIcons.indexOf(tempChar);var endIndex=endIcons.indexOf(tempChar);if(endIndex>=0&&stack[stack.length-1]==endIndex)stack.pop();else if(startIndex>=0)stack.push(startIndex);if(stack.length<=0)return i+1}return-1};TemplateCompiler.prototype.transformToNode=function(str){var regAres=/\$a\-\{/g;var regTrim=/^\s*([\s\S]*)\s*$/;var regCmd=/^\s*([a-zA-Z0-9_]+?)\s*:\s*(.+?)\s*$/;var regEnd=/^\s*end\s+([a-zA-Z0-9_]+?)\s*$/;var nodes=[];var index=0;var length=str.length;var cmdStack=[];var eatCount;for(var resAres=regAres.exec(str);resAres!=null;resAres=regAres.exec(str)){var endIndex=this.getEndIndex(str,resAres.index+resAres[0].length);if(endIndex<0){console.error("指令没有结束"+str.substr(resAres.index));return null}regAres.lastIndex=endIndex;var whole=str.substring(resAres.index,endIndex);var content=whole.substring(resAres[0].length,whole.length-1);eatCount=0;if(resAres.index>index){nodes.push({cmd:"text",exp:str.substring(index,resAres.index)})}var resEnd=regEnd.exec(content);if(resEnd!=null){clearNode();var start=cmdStack.pop();if(start==null){console.error("终结指令("+resEnd[1]+")没有对应的起始指令");return null}if(start.cmd!=resEnd[1]){console.error("起始指令("+start.cmd+")与终结指令("+resEnd[1]+")不匹配");return null}var startIndex=nodes.indexOf(start);start.children=nodes.splice(startIndex+1)}else{var resCmd=regCmd.exec(content);if(resCmd!=null){clearNode();var node={cmd:resCmd[1],exp:resCmd[2]};nodes.push(node);cmdStack.push(node)}else if(content==""){clearNode()}else{nodes.push({cmd:"exp",exp:content})}}index=resAres.index+whole.length+eatCount}if(index<length){nodes.push({cmd:"text",exp:str.substr(index)})}if(cmdStack.length>0){console.error("起始指令"+cmdStack[0].cmd+"没有对应的终结指令");return null}return{cmd:null,exp:null,children:nodes};function clearNode(){var regBlankBefore=/[ \f\t\v]*/;var regBlankAfter=/([ \f\t\v]*((\r\n)|[\r\n]))|([ \f\t\v]*)/g;var lastNode=nodes[nodes.length-1];if(lastNode&&lastNode.cmd=="text"){var index=Math.max(lastNode.exp.lastIndexOf("\r"),lastNode.exp.lastIndexOf("\n"));lastNode.exp=lastNode.exp.substring(0,index+1)+lastNode.exp.substr(index+1).replace(regBlankBefore,"")}regBlankAfter.lastIndex=resAres.index+whole.length;var resBlank=regBlankAfter.exec(str);if(resBlank)eatCount=resBlank[0].length}};return TemplateCompiler}();template_1.TemplateCompiler=TemplateCompiler})(template=ares.template||(ares.template={}))})(ares||(ares={}));var module=module||{};module.exports=ares.template;