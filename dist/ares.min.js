var ares;(function(ares){var Dep=function(){function Dep(){this._map={}}Dep.prototype.watch=function(watcher){if(!this._map[watcher.uid]){this._map[watcher.uid]=watcher}};Dep.prototype.notify=function(extra){for(var uid in this._map){var watcher=this._map[uid];watcher.update(extra)}};return Dep}();ares.Dep=Dep})(ares||(ares={}));var ares;(function(ares){var Watcher=function(){function Watcher(target,exp,scope,callback){this._disposed=false;this._uid=Watcher._uid++;this._target=target;this._exp=exp;this._scope=scope;this._expFunc=ares.utils.createEvalFunc(exp);this._callback=callback;this.update()}Object.defineProperty(Watcher.prototype,"uid",{get:function(){return this._uid},enumerable:true,configurable:true});Watcher.prototype.getValue=function(){if(this._disposed)return null;var value=null;Watcher.updating=this;Object.defineProperty(this._scope,"$target",{configurable:true,enumerable:false,value:this._target,writable:false});try{value=this._expFunc(this._scope)}catch(err){console.error("表达式求值错误，exp："+this._exp+"，scope："+JSON.stringify(this._scope))}delete this._scope["$target"];Watcher.updating=null;return value};Watcher.prototype.update=function(extra){if(this._disposed)return;var value=this.getValue();if(!Watcher.isEqual(value,this._value)){this._callback&&this._callback(value,this._value,extra);this._value=Watcher.deepCopy(value)}};Watcher.prototype.dispose=function(){if(this._disposed)return;this._value=null;this._target=null;this._exp=null;this._scope=null;this._expFunc=null;this._callback=null;this._disposed=true};Watcher.isEqual=function(a,b){return a==b||(Watcher.isObject(a)&&Watcher.isObject(b)?JSON.stringify(a)==JSON.stringify(b):false)};Watcher.isObject=function(obj){return obj&&typeof obj=="object"};Watcher.deepCopy=function(from){if(Watcher.isObject(from)){return JSON.parse(JSON.stringify(from))}else{return from}};return Watcher}();Watcher.updating=null;Watcher._uid=0;ares.Watcher=Watcher})(ares||(ares={}));var ares;(function(ares){var Mutator=function(){function Mutator(){}Mutator.mutate=function(data){if(!data||typeof data!="object")return;if(!data.__ares_mutated__){for(var key in data){Mutator.mutateObject(data,key,data[key])}Object.defineProperty(data,"__ares_mutated__",{value:true,writable:false,enumerable:false,configurable:false})}return data};Mutator.mutateObject=function(data,key,value){var dep=new ares.Dep;Object.defineProperty(data,key,{enumerable:true,configurable:false,get:function(){var watcher=ares.Watcher.updating;if(watcher)dep.watch(watcher);return value},set:function(v){if(v==value)return;value=v;if(Array.isArray(v))Mutator.mutateArray(v,dep);else Mutator.mutate(v);dep.notify()}});Mutator.mutate(value)};Mutator.mutateArray=function(arr,dep){arr["__proto__"]=Mutator.defineReactiveArray(dep);for(var i=0,len=arr.length;i<len;i++){Mutator.mutate(arr[i])}};Mutator.defineReactiveArray=function(dep){var proto=Array.prototype;var result=Object.create(proto);Mutator._arrMethods.forEach(function(method){var oriMethod=proto[method];Object.defineProperty(result,method,{value:function(){var args=[];for(var _i=0;_i<arguments.length;_i++){args[_i]=arguments[_i]}var result=oriMethod.apply(this,args);var inserted;switch(method){case"push":case"unshift":inserted=args;break;case"splice":inserted=args.slice(2);break}if(inserted&&inserted.length){Mutator.mutateArray(inserted,dep)}dep.notify({method:args});return result}})});Object.defineProperty(result,"$set",{value:function(index,value){if(index>=this.length)index=this.length;return this.splice(index,1,value)[0]}});Object.defineProperty(result,"$remove",{value:function(item){var index=this.indexOf(item);if(index>-1)return this.splice(index,1);return null}});return result};return Mutator}();Mutator._arrMethods=["push","pop","unshift","shift","splice","sort","reverse"];ares.Mutator=Mutator})(ares||(ares={}));var ares;(function(ares){var utils;(function(utils){function createEvalFunc(exp){return Function("scope","with(scope){return "+exp+"}")}utils.createEvalFunc=createEvalFunc;function evalExp(exp,scope){return createEvalFunc(exp)(scope)}utils.evalExp=evalExp;function createRunFunc(exp){return Function("scope","with(scope){"+exp+"}")}utils.createRunFunc=createRunFunc;function runExp(exp,scope){createRunFunc(exp)(scope)}utils.runExp=runExp})(utils=ares.utils||(ares.utils={}))})(ares||(ares={}));var ares;(function(ares){function bind(data,compiler,options){return new Ares(data,compiler,options)}ares.bind=bind;var Ares=function(){function Ares(data,compiler,options){this._data=ares.Mutator.mutate(data);this._compiler=compiler;this._options=options;this._compiler.init(this);if(this._options&&this._options.inited){this._options.inited.call(this._data,this)}}Object.defineProperty(Ares.prototype,"data",{get:function(){return this._data},enumerable:true,configurable:true});Object.defineProperty(Ares.prototype,"compiler",{get:function(){return this._compiler},enumerable:true,configurable:true});Ares.prototype.createWatcher=function(target,exp,scope,callback){return new ares.Watcher(target,exp,scope,callback)};return Ares}();ares.Ares=Ares})(ares||(ares={}));var module=module||{};module.exports=ares;