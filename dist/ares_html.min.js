var ares;(function(ares){var utils;(function(utils){function createEvalFunc(exp){return Function("scope","with(scope){return "+exp+"}")}utils.createEvalFunc=createEvalFunc;function evalExp(exp,scope){return createEvalFunc(exp)(scope)}utils.evalExp=evalExp;function createRunFunc(exp){return Function("scope","with(scope){"+exp+"}")}utils.createRunFunc=createRunFunc;function runExp(exp,scope){createRunFunc(exp)(scope)}utils.runExp=runExp})(utils=ares.utils||(ares.utils={}))})(ares||(ares={}));var ares;(function(ares){var html;(function(html){function textContent(context){context.entity.createWatcher(context.exp,context.scope,function(value){context.target.nodeValue=value})}html.textContent=textContent;html.commands={text:function(context){context.entity.createWatcher(context.exp,context.scope,function(value){context.target.textContent=value})},html:function(context){context.entity.createWatcher(context.exp,context.scope,function(value){var target=context.target;target.innerHTML=value;var children=target.childNodes;for(var i=0,len=children.length;i<len;i++){context.compiler.compile(children[i],context.scope)}})},css:function(context){var target=context.target;var oriCls=target.getAttribute("class");context.entity.createWatcher(context.exp,context.scope,function(params){if(typeof params=="string"){if(oriCls)params=oriCls+" "+params;target.setAttribute("class",params)}else{var arr=[];if(oriCls)arr.push(oriCls);for(var cls in params){if(params[cls]==true)arr.push(cls)}if(arr.length>0)target.setAttribute("class",arr.join(" "))}})},attr:function(context){var target=context.target;context.entity.createWatcher(context.exp,context.scope,function(value){if(context.subCmd!=""){target.setAttribute(context.subCmd,value)}else{for(var name in value){var value=value[name];target.setAttribute(name,value)}}})},on:function(context){if(context.subCmd!=""){var handler=context.scope[context.exp]||window[context.exp];if(typeof handler=="function"){context.target.addEventListener(context.subCmd,handler.bind(context.scope))}else{context.target.addEventListener(context.subCmd,function(evt){var scope=Object.create(context.scope);scope.$event=evt;ares.utils.runExp(context.exp,scope)})}}},"if":function(context){var compiled=false;var refNode=document.createTextNode("");context.target.parentNode.insertBefore(refNode,context.target);context.entity.createWatcher(context.exp,context.scope,function(value){if(value==true){if(!compiled){context.compiler.compile(context.target,context.scope);compiled=true}if(!context.target.parentNode){refNode.parentNode.insertBefore(context.target,refNode)}}else{if(context.target.parentNode){context.target.parentNode.removeChild(context.target)}}})},"for":function(context){var reg=/^\s*(\S+)\s+in\s+(\S+)\s*$/;var res=reg.exec(context.exp);if(!res){console.error("for命令表达式错误："+context.exp);return}var itemName=res[1];var arrName=res[2];var pNode=context.target.parentNode;var sNode=document.createTextNode("");var eNode=document.createTextNode("");var range=document.createRange();pNode.replaceChild(eNode,context.target);pNode.insertBefore(sNode,eNode);context.entity.createWatcher(arrName,context.scope,function(value){range.setStart(sNode,0);range.setEnd(eNode,0);range.deleteContents();if(typeof value=="number"){var temp=[];for(var i=0;i<value;i++){temp.push(i)}value=temp}for(var key in value){var newNode=context.target.cloneNode(true);pNode.insertBefore(newNode,eNode);var newScope=Object.create(context.scope);newScope.$index=key;newScope[itemName]=value[key];context.compiler.compile(newNode,newScope)}})}}})(html=ares.html||(ares.html={}))})(ares||(ares={}));var ares;(function(ares){var html;(function(html){var HTMLCompiler=function(){function HTMLCompiler(idOrElement){this._idOrElement=idOrElement}HTMLCompiler.prototype.init=function(entity){if(typeof this._idOrElement=="string")this._root=document.getElementById(this._idOrElement)||document.getElementsByName(this._idOrElement)[0];else this._root=this._idOrElement;this._entity=entity;this.compile(this._root,entity.data)};HTMLCompiler.prototype.compile=function(node,scope){if(node.nodeType==3){this.compileTextContent(node,scope)}else{var hasLazyCompile=false;var attrs=node.attributes;var cmdsToCompile=[];for(var i=0,len=attrs.length;i<len;i++){var attr=attrs[i];var name=attr.name;if(name.indexOf("a-")==0||name.indexOf("data-a-")==0){var bIndex=name.charAt(0)=="d"?7:2;var eIndex=name.indexOf(":");if(eIndex<0)eIndex=name.length;var cmdName=name.substring(bIndex,eIndex);var cmd=html.commands[cmdName];if(cmd){var subCmd=name.substr(eIndex+1);var exp=attr.value;cmdsToCompile.push({attr:attr,cmd:cmd,ctx:{scope:scope,target:node,subCmd:subCmd,exp:exp,compiler:this,entity:this._entity}});if(cmdName=="if"||cmdName=="for"){hasLazyCompile=true;cmdsToCompile.splice(0,cmdsToCompile.length-1);break}}}}for(var i=0,len=cmdsToCompile.length;i<len;i++){var cmdToCompile=cmdsToCompile[i];cmdToCompile.attr.ownerElement.removeAttribute(cmdToCompile.attr.name);cmdToCompile.cmd(cmdToCompile.ctx)}if(!hasLazyCompile){var children=node.childNodes;for(var i=0,len=children.length;i<len;i++){var child=children[i];this.compile(child,scope)}}}};HTMLCompiler.prototype.compileTextContent=function(node,scope){if(HTMLCompiler._textExpReg.test(node.nodeValue)){var exp=this.parseTextExp(node.nodeValue);html.textContent({scope:scope,target:node,subCmd:"",exp:exp,compiler:this,entity:this._entity})}};HTMLCompiler.prototype.parseTextExp=function(exp){var reg=HTMLCompiler._textExpReg;for(var result=reg.exec(exp);result!=null;result=reg.exec(exp)){exp=result[1]+"${"+result[2]+"}"+result[3]}return"`"+exp+"`"};HTMLCompiler._textExpReg=/(.*?)\{\{(.*?)\}\}(.*)/;return HTMLCompiler}();html.HTMLCompiler=HTMLCompiler})(html=ares.html||(ares.html={}))})(ares||(ares={}));